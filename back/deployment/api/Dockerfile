FROM node:10.15-stretch

WORKDIR /usr/app

COPY package*.json ./

RUN apt-get install -y curl
RUN npm ci --only=production
RUN npm install pm2 -g
RUN npm install prisma@1.32 -g

COPY deployment/api/start.sh .
COPY . .

EXPOSE 4000

ARG PRISMA_ENDPOINT=http://robjinman-com-prisma:4466
ARG PRISMA_MANAGEMENT_API_SECRET=XXXXXXXX
ARG PRISMA_SECRET=XXXXXXXX
ARG APP_SECRET=XXXXXXXX
ARG RECAPTCHA_SECRET_KEY=XXXXXXXX
ARG EMAIL_PASSWORD=XXXXXXXX

ENV PRISMA_ENDPOINT=$PRISMA_ENDPOINT
ENV PRISMA_MANAGEMENT_API_SECRET=$PRISMA_MANAGEMENT_API_SECRET
ENV PRISMA_SECRET=$PRISMA_SECRET
ENV APP_SECRET=$APP_SECRET
ENV RECAPTCHA_SECRET_KEY=$RECAPTCHA_SECRET_KEY
ENV EMAIL_PASSWORD=$EMAIL_PASSWORD

CMD ["./start.sh"]
